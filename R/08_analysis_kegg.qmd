---
title: "08_analysis_KEGG"
author: "Julie Bruun Brockhoff (s204519), Cecilie Kejlberg Leth (s204584), Amalie Drud Nielsen (s204560), Chrysillis Hellemann Polhaus (s153664), Lise Lotte Eriksen (s154123)"
format: 
  html:
    embed-resources: true
editor: visual
output-dir: ../results
editor_options: 
  chunk_output_type: inline
---

### Loading packages

```{r, include=FALSE}
library(here)
library(readr)
library(tidyverse)
library(biomaRt)
library(clusterProfiler)
library(enrichplot)
```

### Load data

```{r, include=FALSE}
data <- read_tsv(file = here("data/03_dat_aug.tsv"))
```

### Get gene IDs for each gene name

Using ensembl and NCBI to retrieve all of the gene IDs for our data. The NCBI database is chosen because the IDs needs to match with the KEGG database. The IDs are then joined with the our data based on the gene names.

```{r}
#connect to ensembl to fetch IDs
mart <- useMart("ensembl", 
                dataset = "hsapiens_gene_ensembl") 

gene_info <- getBM(
  attributes = c("external_gene_name", "entrezgene_id"),
  filters = "external_gene_name",
  values = data |>
    pull(gene),
  mart = mart)

#Join the data and rearrange the new ID column after the old column.
data_with_ID <- data |> 
  right_join(gene_info, 
            by = c("gene" = "external_gene_name")) |>
  relocate(entrezgene_id, 
           .after = gene)

```

### All up- and down-regulated are separated into individual lists for each cell line.

```{r}
#Separate data into upregulated and downregulated DEGs with geneIDs
data_OVCAR3_upregulated <- data_with_ID |> 
  filter(DEG_OVCAR3 == "Upregulated") |> 
  dplyr::select(gene, entrezgene_id, OVCAR3_MOCK, OVCAR3_KO, log2FC_OVCAR3)

data_OVCAR3_downregulated <- data_with_ID |> 
  filter(DEG_OVCAR3 == "Downregulated") |> 
  dplyr::select(gene, entrezgene_id, OVCAR3_MOCK, OVCAR3_KO, log2FC_OVCAR3)

data_SKOV3_upregulated <- data_with_ID |> 
  filter(DEG_SKOV3 == "Upregulated") |> 
  dplyr::select(gene, entrezgene_id, SKOV3_MOCK, OVCAR3_KO, log2FC_SKOV3)

data_SKOV3_downregulated <- data_with_ID |> 
  filter(DEG_SKOV3 == "Downregulated") |> 
  dplyr::select(gene, entrezgene_id, SKOV3_MOCK, SKOV3_KO, log2FC_SKOV3)

#save the geneIDs seperately for each cell line and type of regulation:
geneIDs_OVCAR3_upregulated <- data_OVCAR3_upregulated |> 
  rename(geneIDs = entrezgene_id) |>  
  pull(geneIDs) |> 
  na.omit()

geneIDs_SKOV3_downregulated <- data_SKOV3_downregulated |> 
  rename(geneIDs = entrezgene_id) |>  
  pull(geneIDs) |> 
  na.omit()

geneIDs_SKOV3_upregulated <- data_SKOV3_upregulated |> 
  rename(geneIDs = entrezgene_id) |>  
  pull(geneIDs) |> 
  na.omit()

geneIDs_OVCAR3_downregulated <- data_OVCAR3_downregulated |> 
  rename(geneIDs = entrezgene_id) |>  
  pull(geneIDs) |> 
  na.omit()

```

### KEGG enrichment for all up-regulated genes in OVCAR3

```{r}
kegg_analysis_OVCAR3_upregulated <- enrichKEGG(gene = geneIDs_OVCAR3_upregulated,
                                               organism = "hsa",
                                               pAdjustMethod = "BH",
                                               minGSSize = 10,
                                               maxGSSize = 500,
                                               qvalueCutoff = 0.05) |> 
  as_tibble()

plot_kegg_OVCAR3_upregulated <- kegg_analysis_OVCAR3_upregulated |> 
  slice_min(order_by = p.adjust, 
            n = 10) |> 
  mutate(Description = fct_reorder(Description, p.adjust, .desc = TRUE)) |>
  ggplot(aes(x = Count, 
             y = Description)) + 
  geom_point(aes(size = Count, 
                 color = p.adjust)) + 
  scale_color_gradient(low = "red", 
                       high = "blue", 
                       name = "p.adjust") + 
  labs(
    title = "KEGG Pathway Enrichment Analysis for upregulated \ngenes in OVCAR3",
    x = "Gene Count",
    y = "Pathways") +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 18),
    plot.title = element_text(size = 24),
    axis.title = element_text(size = 18),
    legend.text = element_text(size = 10))

plot_kegg_OVCAR3_upregulated

```

Only one pathway was significantly up-regulated for the OVCAR3 cell line.

The KEGG is saved in a png-file in the results folder:

```{r}
ggsave(filename = here("results/08_key_plot_1.png"),
       plot = plot_kegg_OVCAR3_upregulated,
       width = 10, 
       height = 6)
```

### KEGG enrichment for all down-regulated genes in OVCAR3

```{r}
kegg_analysis_OVCAR3_downregulated <- enrichKEGG(gene = geneIDs_OVCAR3_downregulated,
                                                 organism = "hsa", 
                                                 pAdjustMethod = "BH",
                                                 minGSSize = 10,
                                                 maxGSSize = 500,
                                                 qvalueCutoff = 0.05) |> 
  as_tibble()

plot_kegg_OVCAR3_downregulated <- kegg_analysis_OVCAR3_downregulated |> 
  slice_min(order_by = p.adjust, 
            n = 10) |>               
  mutate(Description = fct_reorder(Description, p.adjust, .desc = TRUE)) |>   
  ggplot(aes(x = Count, 
             y = Description)) +                
  geom_point(aes(size = Count, 
                 color = p.adjust)) +        
  scale_color_gradient(low = "red", 
                       high = "blue", 
                       name = "p.adjust") +  
  labs(
    title = "KEGG Pathway Enrichment Analysis for downregulated \ngenes in OVCAR3",
    x = "Gene Count",
    y = "Pathways") +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 18,),
    plot.title = element_text(size = 24),
    axis.title = element_text(size = 18),
    legend.text = element_text(size = 10))

plot_kegg_OVCAR3_downregulated

```

Several pathways were enriched when looking at the DEGs that were down-regulated in the OVCAR3 KO cell line. The top 3 pathways are all related to cancer, but also cellular senescence is seen in the plot.

The KEGG is saved in a png-file in the results folder:

```{r}
ggsave(filename = here("results/08_key_plot_2.png"),
       plot = plot_kegg_OVCAR3_downregulated,
       width = 10, 
       height = 6)
```

### KEGG enrichment for all up-regulated genes in SKOV3

```{r}
kegg_analysis_SKOV3_upregulated <- enrichKEGG(gene = geneIDs_SKOV3_upregulated,
                                               organism = "hsa",
                                               pAdjustMethod = "BH",
                                               minGSSize = 10,
                                               maxGSSize = 500,
                                               qvalueCutoff = 0.05) |> 
  as_tibble()

plot_kegg_SKOV3_upregulated <- kegg_analysis_SKOV3_upregulated |> 
  slice_min(order_by = p.adjust, 
            n = 10) |> 
  mutate(Description = fct_reorder(Description, p.adjust, .desc = TRUE)) |>
  ggplot(aes(x = Count, 
             y = Description)) + 
  geom_point(aes(size = Count, 
                 color = p.adjust)) + 
  scale_color_gradient(low = "red", 
                       high = "blue", 
                       name = "p.adjust") + 
  labs(
    title = "KEGG Pathway Enrichment Analysis for upregulated genes in SKOV3",
    x = "Gene Count",
    y = "Pathways") +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 12, 
                               color = "black"),
    plot.title = element_text(hjust = 0.5, 
                              size = 24),
    axis.title = element_text(size = 18))

plot_kegg_SKOV3_upregulated

```

There are no significantly up-regulated pathways in SKOV3.

### KEGG enrichment for all down-regulated genes in SKOV3

```{r}
kegg_analysis_SKOV3_downregulated <- enrichKEGG(gene = geneIDs_SKOV3_downregulated,
                                                organism = "hsa", 
                                                pAdjustMethod = "BH",
                                                minGSSize = 10,
                                                maxGSSize = 500,
                                                qvalueCutoff = 0.05) |> 
  as_tibble()

plot_kegg_SKOV3_downregulated <- kegg_analysis_SKOV3_downregulated |> 
  slice_min(order_by = p.adjust, 
            n = 10) |>               
  mutate(Description = fct_reorder(Description, p.adjust, .desc = TRUE)) |>   
  ggplot(aes(x = Count, 
             y = Description)) +                
  geom_point(aes(size = Count, 
                 color = p.adjust)) +        
  scale_color_gradient(low = "red", 
                       high = "blue", 
                       name = "p.adjust") +  
  labs(
    title = "KEGG Pathway Enrichment Analysis for downregulated genes in SKOV3",
    x = "Gene Count",
    y = "Pathways") +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 12, 
                               color = "black"),
    plot.title = element_text(hjust = 0.5, 
                              size = 24),
    axis.title = element_text(size = 18))

plot_kegg_SKOV3_downregulated
```

There are no significantly down-regulated pathways in SKOV3.

The KEGG analysis indicate that the majority of the regulation can only be seen in the OVCAR3 cell line.
